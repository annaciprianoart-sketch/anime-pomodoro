<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Anime Pomodoro V4 (Round Buttons Fix)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-font: 'Montserrat', sans-serif;
            --accent-color: #4a6153; /* Cor escura para o botão START (estilo ref) */
            --text-color: #ffffff; 
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.2);
            --icon-bg: rgba(255, 255, 255, 0.25); /* Para botões redondos */
            --dark-overlay: rgba(0, 0, 0, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--primary-font);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            transition: background-image 0.5s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #333;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--dark-overlay);
            z-index: 0;
        }

        /* Container Principal */
        .timer-container {
            position: relative;
            z-index: 1;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            padding: 2.5rem 2rem;
            width: 400px;
            max-width: 95vw;
            text-align: center;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Badge estilo pílula */
        .status-badge {
            display: inline-block;
            padding: 8px 24px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-color);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Display do Timer */
        .timer-display {
            font-size: 5.5rem;
            font-weight: 700;
            line-height: 1;
            margin: 0 0 2rem 0;
            text-shadow: 0 2px 15px rgba(0,0,0,0.2);
            font-variant-numeric: tabular-nums;
            color: var(--text-color);
            letter-spacing: -2px;
        }

        /* Área dos Controles */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        button {
            border: none;
            cursor: pointer;
            font-family: var(--primary-font);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Botão START Principal (Retangular Escuro) */
        .btn-main {
            background: var(--accent-color);
            color: white;
            padding: 14px 36px;
            border-radius: 16px;
            font-size: 1.2rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 140px;
        }

        .btn-main:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        /* Botões de Ícone (Circulares de Vidro) - CORREÇÃO AQUI */
        .btn-icon {
            background: var(--icon-bg);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 1px solid var(--glass-border);
            color: var(--text-color);
            /* Adições para garantir círculo perfeito: */
            padding: 0;
            flex-shrink: 0; /* Impede que sejam esmagados */
            aspect-ratio: 1 / 1; /* Força proporção quadrada/circular */
        }
        
        /* Estilo para os SVGs dentro dos botões */
        .btn-icon svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            opacity: 0.8;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.4);
        }
        .btn-icon:hover svg {
            opacity: 1;
        }

        /* Indicador de Ciclo (Bolinhas) */
        .cycle-dots {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .dot.active {
            background: #ffffff; /* Bolinha ativa branca */
            box-shadow: 0 0 12px rgba(255,255,255,0.6);
            transform: scale(1.15);
        }

        /* --- MENU DE CONFIGURAÇÕES (Settings Modal) --- */
        .settings-modal {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(20, 20, 20, 0.95); /* Fundo bem escuro */
            border-radius: 30px;
            z-index: 10;
            padding: 2rem;
            text-align: left;
            overflow-y: auto;
            color: #ffffff;
        }

        .settings-modal.open {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 1rem;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .setting-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.7rem;
            opacity: 0.9;
            color: #ddd;
        }

        .setting-group input[type="number"],
        .setting-group input[type="text"] {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #444;
            background: #333;
            color: white;
            font-family: var(--primary-font);
            font-size: 1rem;
        }
        
        .setting-group input[type="color"] {
            width: 100%;
            height: 45px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            padding: 0;
            background: transparent;
        }

        .close-btn {
            background: transparent;
            color: white;
            font-size: 2rem;
            width: auto;
            height: auto;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbar customizada para o modal */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #666; border-radius: 3px; }

    </style>
</head>
<body>

    <div class="overlay"></div>

    <div class="timer-container" id="container">
        <div class="status-badge" id="mode-text">Work Time</div>
        
        <div class="timer-display" id="time-display">25:00</div>

        <div class="controls">
            <button class="btn-icon" id="settings-btn" title="Settings">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.06-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.73,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.85,11.36,4.8,11.69,4.8,12s0.02,0.64,0.06,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></svg>
            </button>
            
            <button class="btn-main" id="start-btn">START</button>

            <button class="btn-icon" id="skip-btn" title="Skip current timer">
               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
            </button>
            
            <button class="btn-icon" id="reset-btn" title="Reset Cycle">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-0.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14 0.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
            </button>
        </div>

        <div class="cycle-dots">
            <div class="dot" id="dot-1"></div>
            <div class="dot" id="dot-2"></div>
            <div class="dot" id="dot-3"></div>
            <div class="dot" id="dot-4"></div>
        </div>

        <div class="settings-modal" id="settings-modal">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="close-btn" id="close-settings">&times;</button>
            </div>

            <div class="setting-group">
                <label>Work Time (minutes)</label>
                <input type="number" id="pomo-time" value="25" min="1">
            </div>
            <div class="setting-group">
                <label>Short Break (minutes)</label>
                <input type="number" id="short-time" value="5" min="1">
            </div>
            <div class="setting-group">
                <label>Long Break (minutes)</label>
                <input type="number" id="long-time" value="15" min="1">
            </div>

            <div class="setting-group">
                <label>Start Button Color</label>
                <input type="color" id="accent-color" value="#4a6153">
            </div>
             <div class="setting-group">
                <label>Background Image URL (GIF/JPG)</label>
                <input type="text" id="bg-url" placeholder="https://...">
            </div>

            <button class="btn-main" id="save-settings" style="width: 100%; margin-top: 1rem;">Save & Apply</button>
        </div>
    </div>

    <script>
        // Imagens de fundo padrão (Estilo Lofi/Anime)
        const bgImages = [
            "https://i.pinimg.com/originals/85/6a/28/856a282f42a609d93616256f082e0431.gif", 
            "https://i.pinimg.com/originals/69/34/4e/69344ec3c22b406e9021e8e873d3f92d.gif", 
            "https://i.gifer.com/7d20.gif",
            "https://media.tenor.com/images/39fe167bdab90223bcc890bcb067b761/tenor.gif"
        ];

        // Elementos DOM
        const timeDisplay = document.getElementById('time-display');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');
        const skipBtn = document.getElementById('skip-btn'); // Novo botão skip
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettingsBtn = document.getElementById('close-settings');
        const saveSettingsBtn = document.getElementById('save-settings');
        const modeText = document.getElementById('mode-text');
        
        const dots = [
            document.getElementById('dot-1'),
            document.getElementById('dot-2'),
            document.getElementById('dot-3'),
            document.getElementById('dot-4')
        ];

        // Inputs do Modal Settings
        const inputs = {
            pomo: document.getElementById('pomo-time'),
            short: document.getElementById('short-time'),
            long: document.getElementById('long-time'),
            bg: document.getElementById('bg-url'),
            color: document.getElementById('accent-color')
        };

        // Estado da Aplicação
        let timer = null;
        let isRunning = false;
        let timeLeft = 25 * 60;
        let cycleCount = 0; // Conta quantos Pomodoros foram feitos (0 a 4)
        let currentMode = 'pomo'; // 'pomo', 'short', 'long'

        // Configurações Iniciais
        let settings = {
            pomoTime: 25,
            shortTime: 5,
            longTime: 15,
            accentColor: '#4a6153',
            customBg: ''
        };

        // --- FUNÇÕES DE ÁUDIO ---
        // Gera um "bip" simples usando a API de áudio do navegador (não precisa de arquivo externo)
        function playAlarm() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                // Configuração do som (frequência e tipo)
                osc.type = 'sine';
                osc.frequency.value = 800; // Tom agudo agradável
                
                // Volume (Fade out rápido para não estourar)
                gain.gain.setValueAtTime(0.15, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.8);
                
                osc.start();
                osc.stop(ctx.currentTime + 0.8);
            }
        }

        // --- FUNÇÕES PRINCIPAIS ---

        function init() {
            setRandomBackground();
            updateTimerDisplay();
            applySettingsColors();
        }

        function setRandomBackground() {
            if (settings.customBg && settings.customBg.trim() !== "") return; // Se tiver BG personalizado, não usa aleatório
            const randomImg = bgImages[Math.floor(Math.random() * bgImages.length)];
            document.body.style.backgroundImage = `url('${randomImg}')`;
        }

        function updateTimerDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            // Formata para MM:SS
            timeDisplay.textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            // Atualiza título da aba
            document.title = `${timeDisplay.textContent} - ${currentMode.toUpperCase()}`;
        }

        function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                startTimer();
            }
        }

        function startTimer() {
            isRunning = true;
            startBtn.textContent = "PAUSE";
            // Garante que só existe um intervalo rodando
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    updateTimerDisplay();
                } else {
                    // O tempo acabou
                    handleTimerComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            clearInterval(timer);
            isRunning = false;
            startBtn.textContent = "START";
        }

        // Função chamada quando o tempo acaba (ou quando clica em Skip)
        function handleTimerComplete() {
            clearInterval(timer);
            isRunning = false;
            playAlarm(); // Toca o som
            
            // Lógica do Ciclo Pomodoro
            if (currentMode === 'pomo') {
                // Terminou um Pomodoro
                cycleCount++;
                updateDots();
                
                if (cycleCount < 4) {
                    // Se ainda não completou 4, vai para pausa curta
                    switchMode('short');
                    autoStart();
                } else {
                    // Se completou 4, vai para pausa longa
                    switchMode('long');
                    autoStart();
                }
            } else if (currentMode === 'short') {
                // Terminou pausa curta, volta para o trabalho
                switchMode('pomo');
                autoStart();
            } else if (currentMode === 'long') {
                // Terminou a pausa longa. Fim do ciclo completo.
                fullReset();
                // Não inicia automaticamente, espera o usuário.
            }
        }

        // Muda o modo atual e reseta o tempo correspondente
        function switchMode(mode) {
            currentMode = mode;
            if (mode === 'pomo') {
                timeLeft = settings.pomoTime * 60;
                modeText.textContent = "Work Time";
            } else if (mode === 'short') {
                timeLeft = settings.shortTime * 60;
                modeText.textContent = "Short Break";
            } else if (mode === 'long') {
                timeLeft = settings.longTime * 60;
                modeText.textContent = "Long Break";
            }
            updateTimerDisplay();
            pauseTimer(); // Garante que o botão volte para "START" visualmente antes do auto-start
        }

        // Inicia o próximo timer automaticamente após uma breve pausa
        function autoStart() {
            setTimeout(() => {
                startTimer();
            }, 1500); // Delay de 1.5s para o usuário perceber a mudança
        }

        // Atualiza as bolinhas indicadoras
        function updateDots() {
            dots.forEach((dot, index) => {
                if (index < cycleCount) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Reseta tudo para o estado inicial
        function fullReset() {
            pauseTimer();
            cycleCount = 0;
            updateDots();
            switchMode('pomo');
        }

        function applySettingsColors() {
             document.documentElement.style.setProperty('--accent-color', settings.accentColor);
        }

        // --- EVENT LISTENERS (Interações) ---

        startBtn.addEventListener('click', toggleTimer);
        resetBtn.addEventListener('click', fullReset);
        // Botão Skip chama a função de finalização imediatamente
        skipBtn.addEventListener('click', handleTimerComplete);

        // Abrir/Fechar Modal de Settings
        settingsBtn.addEventListener('click', () => settingsModal.classList.add('open'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('open'));

        // Salvar Settings
        saveSettingsBtn.addEventListener('click', () => {
            // Captura valores dos inputs
            settings.pomoTime = parseInt(inputs.pomo.value);
            settings.shortTime = parseInt(inputs.short.value);
            settings.longTime = parseInt(inputs.long.value);
            settings.accentColor = inputs.color.value;
            settings.customBg = inputs.bg.value;

            // Aplica cores
            applySettingsColors();

            // Aplica Imagem de fundo personalizada se houver
            if (settings.customBg && settings.customBg.trim() !== "") {
                document.body.style.backgroundImage = `url('${settings.customBg}')`;
            } else {
                // Se limpou o campo, volta para imagem aleatória
                setRandomBackground();
            }

            // Se o timer não estiver rodando, atualiza o display com o novo tempo configurado
            if (!isRunning) {
                switchMode(currentMode);
            }

            settingsModal.classList.remove('open');
        });

        // Preview da cor em tempo real no modal
        inputs.color.addEventListener('input', (e) => {
             document.documentElement.style.setProperty('--accent-color', e.target.value);
        });

        // Inicializa o widget
        init();
    </script>
</body>
</html>
